# wepub

## Introduction
基于tornado的软件版本发布系统，利用saltstack sdk批量管理集群。

具有以下几种主要资源抽象(完整的RESTful风格)：
* Node: 节点, url路由: `/node`
* NodeGroup: 节点组, url路由: `/nodegroup`
* App: 应用软件, url路由: `nodegroup`
* Job: 作业, url路由: `/job`
* Task: 任务, url路由: `/task`

`Task`的执行最终是落实到每个`Node`去执行，每个`Task`可以由多个`Job`有序组成。

`App`是软件发版`Task`的基本资源（`Task`也可以做非发版的任务，与正常saltstack任务无异）。

`NodeGroup`是为了方便管理人员安排“集群”这个概念而做的抽象，每个`NodeGroup`可以是物理机、容器、或其混合组成的群组，每个群组在管理员看来是什么意义是由管理员自己定义的。

**每个Task就是一个发版任务，该任务要发布哪些节点，随着任务的创建就需要指明。`一个Task`的意义仅止于此，而非`一个Task`搞定一个软件的某次所有升级任务。**

### 使用场景示例：
一个管理员供管理 1000 个RDS集群，共3000个容器节点，运行在容器内的RDS管理程序mcluster发布了新版本，需要将这3000个节点中的mcluster都升级至最新版。

* 不好的用法：
    创建一个Task，囊括了3000个容器节点，期望在wepub上进行简单的配置即可自动灰度发布。

* 不好的原因：
    (你不会一大早就把一天的三顿饭全部做好然后等着到时间就吃)

    一次性囊括所有容器，任务的可控性和灵活性变得很差，当未知情况发生时，任务不好暂停或回滚。如果发布时间跨越数天或者数周，需要有机制不间断监控任务的执行状态，下一次该多久执行，执行多少等等问题。

    如果要一个Task就解决掉上面的问题虽然可以，但是Task模块本身的复杂性将变高以及代码的维护性变差。

* 更好地用法
  将每个RDS集群的三个节点分别创建成一个NodeGroup。这样wepub中就记录了1000个RDS集群。灰度发布的第一次期望发布100个RDS集群，则再创建一个NodeGroup来包含这准备发版的100个RDS集群节点信息。
  该次灰度发版任务将100个集群升级完毕即算发版完成。

  当观察可以批量升级后，第二次发版再创建新的`Task`指定要发版的节点。

## Install and deploy
```shell
python wepub/run.py
```

## Usage

